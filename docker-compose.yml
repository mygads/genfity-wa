# ===================================================================================
# WHATSAPP API (GENFITY-WA) - DOCKER COMPOSE (LOCAL DEVELOPMENT)
# ===================================================================================
# 
# Builds images locally from source code
# All values MUST be set in .env file
#
# USAGE:
#   cp .env.example .env   # Edit with your values
#   docker compose up -d --build
#
# ===================================================================================

services:
  whatsapp-api:
    build:
      context: .
      dockerfile: Dockerfile
    image: genfity-wa:local
    container_name: wa-api
    ports:
      - "8080:8080"
    environment:
      # Database
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      DB_SSLMODE: ${DB_SSLMODE}
      
      # Application
      PORT: ${PORT}
      TZ: ${TZ}
      GIN_MODE: ${GIN_MODE}
      LOG_LEVEL: ${LOG_LEVEL}
      
      # Authentication
      WA_ADMIN_TOKEN: ${WA_ADMIN_TOKEN}
      
      # Security / Encryption
      WA_GLOBAL_ENCRYPTION_KEY: ${WA_GLOBAL_ENCRYPTION_KEY:-}
      WA_GLOBAL_HMAC_KEY: ${WA_GLOBAL_HMAC_KEY:-}
      
      # Webhook
      WA_GLOBAL_WEBHOOK: ${WA_GLOBAL_WEBHOOK:-}
      WEBHOOK_FORMAT: ${WEBHOOK_FORMAT}
      
      # Session
      SESSION_DEVICE_NAME: ${SESSION_DEVICE_NAME}
      
      # RabbitMQ (Optional)
      RABBITMQ_URL: ${RABBITMQ_URL:-}
      RABBITMQ_QUEUE: ${RABBITMQ_QUEUE:-}
      
      # Webhook Retry (Optional)
      WEBHOOK_RETRY_ENABLED: ${WEBHOOK_RETRY_ENABLED:-}
      WEBHOOK_RETRY_COUNT: ${WEBHOOK_RETRY_COUNT:-}
      WEBHOOK_RETRY_DELAY_SECONDS: ${WEBHOOK_RETRY_DELAY_SECONDS:-}
      WEBHOOK_ERROR_QUEUE_NAME: ${WEBHOOK_ERROR_QUEUE_NAME:-}
    volumes:
      - wa-sessions:/app/sessions
      - wa-static:/app/static
    networks:
      - wa-network
      - infra-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      # Traefik
      - "traefik.enable=true"
      - "traefik.http.routers.wa-api.rule=Host(`api-wa.genfity.com`)"
      - "traefik.http.routers.wa-api.entrypoints=websecure"
      - "traefik.http.routers.wa-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.wa-api.loadbalancer.server.port=8080"
      - "traefik.http.routers.wa-api.middlewares=wa-api-cors"
      - "traefik.http.middlewares.wa-api-cors.headers.accessControlAllowOriginList=https://genfity.com,https://www.genfity.com"
      - "traefik.http.middlewares.wa-api-cors.headers.accessControlAllowMethods=GET,POST,PUT,DELETE,OPTIONS"
      - "traefik.http.middlewares.wa-api-cors.headers.accessControlAllowHeaders=Content-Type,Authorization"

networks:
  wa-network:
    external: true
    name: wa-network
  infra-network:
    external: true
    name: infra-network

volumes:
  wa-sessions:
    name: wa-sessions
  wa-static:
    name: wa-static
